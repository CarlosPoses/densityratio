---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(densityratio)
```

# Introduction

The goal of the `densityratio` package is to provide an accessible, complete and easy way to perform density ratio estimation. It includes functionality to estimate density ratios using different methods, summarize and examine the results - including visualization features.

In this vignette, we guide through a full user case: how to estimate density ratios, how to examine and visualize the results, and a usecase of density ratios in practice for covariate shift adaptation.

Throughout the vignette, we illustrate the functionality using the penguins dataset. We can load the dataset from the `palmerpenguins` package. After loading it, we split the data into two parts: the numerator and the denominator. For simplicity, we use a 50-50 split and we only use data with numeric variables.


```{r}
library(palmerpenguins)
library(dplyr)
library(tidyr)
data <- penguins |> 
  select(starts_with("bill") | starts_with("flipper") | starts_with("body_mass") | year) |> 
  na.omit()
  
summary(data)

summary(data)
psych::describe(data)

prob <- data |> 
  mutate(z = -9 + 0.0025*body_mass_g,
         prob = 1/(1 + exp(-z))) 
cor(prob)
set.seed(431)
index <- sample(1:nrow(data), size = nrow(data) * 0.5, prob = prob$prob)
index
numerator <- data[index,]
denominator <- data[-index, ]
numerator
denominator
summary(numerator)
summary(denominator)

numerator <- data |> 
  filter(body_mass_g > 4050) 
denominator <- data |> 
  filter(body_mass_g <= 4050)

predict(densratio)
```


# Density ratio estimation

A density ratio is simply a ratio of the density of two samples:
$$r(x) = \frac{p_\text{nu}(x)}{p_{\text{de}}(x)},$$ 

The package provides functionality to estimate a density ratio using different methods, most notably without directly estimating the numerator and denominator density separately. The key idea is that differences between data distributions can be captured in their density ratio, which is estimated
over the entire multivariate space of the data. Subsequently, the density ratio values can be examined, or summarized in different ways. Density ratio estimation serves many purposes, for example, prediction, outlier detection, change-point detection in time-series, importance weighting
under domain adaptation (i.e., sample selection bias) and evaluation of synthetic data utility. 


The package includes different methods for density ratio estimation. Each of these methods has its own function, but all the functions work similarly. The user provides two datasets (numerator and denominator), and the function returns a `densityratio` object, which can be used and examined.

For instance, we can use the function `ulsif()`, which accounts for 'unconstrained least-squares importance fitting'. The function is called as follows:

```{r}
densratio <- ulsif(numerator, denominator)
plot(densratio, logscale = FALSE)
hist(predict(densratio, newdata = numerator))
hist(predict(densratio, newdata = denominator))
debug(densityratio:::dr.histogram)
```
If no extra parameters are provided, the function uses default values and, when possible, determines optimal parameters through cross-validation. Different methods are available for the resulting object.

```{r}
summary(densratio, test = TRUE)
```
The summary method displays information regarding estimation (e.g., optimal sigma and lambda), the Pearson divergence (a measure of discrepancy between densities), and the test results. 

Other density ratio estimation methods are available, concretely: Kullback-Leibler importance estimation procedure (`kliep()`), ratio of estimated densities (`naive()`), ratio of estimated densities after dimension reduction (`naivesubspace()`), least-squares heterodistributional subspace search (`lhss()`), and 'spectral estimation?` (`spectral()`).

There is also a `print` method, and a `predict` method. The predict method can be used to predict density ratios for new data, or to get the density ratio predictions for the observed data.

```{r}
predict(densratio, data = numerator)
print(densratio)
plot(densratio)
```


# Visualization methods

The package includes different visualization methods to examine the density ratio results. The plots are built with `ggplot2`, and thus return a customizable `ggplot2` object. 

The default `plot` method results in a histogram of the log of the density ratio values. The `plot()` method takes different arguments, so you can plot the densityratio for only some samples, not using the log scale, etc. You can check them with `?plot.ulsif`.

The function is meant to given an overview of the similarity of the samples. For equal samples, the density ratio should be 1, and thus its log should be zero. Therefore, we expect the distribution to be centered around zero, and with no major differences of the distribution between numerator and denominator samples. 

In cases where the numerator and denominator samples have different densities, the density ratio values will be different from 1. We no longer expect the distribution to be centered at zero, and we expect to see differences in the distributions between the numerator and denominator samples (one having larger values than the other).
Â´
```{r}
plot(densratio)
```
There are two other visualization functions, `plot_univariate()` and `plot_bivariate()`. The `plot_univariate()` function plots the value of the density ratio for each variable separately, againas the density ratio. The function plot_

while the `plot_bivariate()` function plots the value of the density ratio for pairs of variables. 


The first one plots the density ratio values for each variable separately, while the second one plots the density ratio values for pairs of variables. 
  


most important visualization method is the `plot` method, which can be used to plot the density ratio values. The plot method can be used to plot the density ratio values for the observed data, or for new data.


# User case: covariate shift adaptation

https://archive.ics.uci.edu/dataset/1/abalone

lm, randomForest, gbm
